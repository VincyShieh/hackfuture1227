<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿé™…å»ºé€ å¸ˆ - æ˜Ÿæ˜Ÿçš„é‚€çº¦</title>
    <style>
        :root {
            --space-bg: #05070a;
            --primary: #ff4d4d; /* çº¢é¢†å·¾è‰² */
            --accent: #ffcc00;
            --telescope-size: 400px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', "Microsoft YaHei", sans-serif; }
        body { background: var(--space-bg); color: white; height: 100vh; overflow: hidden; }

        .page { display: none; height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; }
        .page.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* --- ç”»é¢ä¸€ï¼šå…³å¡å¼€å¯ --- */
        #page-intro {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('bg.png') center/cover;
        }
        .intro-card { background: rgba(0,0,0,0.7); padding: 40px; border-radius: 20px; border: 1px solid var(--accent); text-align: center; backdrop-filter: blur(10px); }

        /* --- ç”»é¢äºŒ/ä¸‰ï¼šæ¸¸æˆç©ºé—´ --- */
        #page-explore { background: #000; cursor: crosshair; }
        .sky-world {
            position: absolute; width: 5000px; height: 3000px;
            background: url('bg1.png') center/cover, radial-gradient(circle at center, #1b2735 0%, #05070a 100%);
            top: 0; left: 0; transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .ground-overlay {
            position: absolute; width: 100vw; height: 100vh; bottom: 0; left: 0;
            background: url('https://images.unsplash.com/photo-1590333746438-2b1950005d7b?q=80&w=2070&auto=format&fit=crop') center/bottom no-repeat;
            background-size: cover; z-index: 5;
        }

        /* æœ›è¿œé•œè§†è§‰ */
        .telescope-lens {
            position: fixed; width: var(--telescope-size); height: var(--telescope-size);
            border: 8px solid rgba(255,255,255,0.2); border-radius: 50%;
            transform: translate(-50%, -50%); left: var(--mx, 50%); top: var(--my, 50%);
            pointer-events: none; z-index: 21;
            box-shadow: 0 0 0 5000px rgba(0,0,0,0.85);
        }

        .star-dot {
            position: absolute; width: 16px; height: 16px; background: white;
            border-radius: 50%; box-shadow: 0 0 10px #fff; cursor: pointer;
            z-index: 10; transform: translate(-50%, -50%); transition: transform 0.2s;
        }
        .star-dot.active { background: var(--accent); box-shadow: 0 0 20px var(--accent); }

        .move-hints {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 40px; z-index: 30;
        }
        .key-hint { background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 10px; border: 1px solid white; font-size: 0.8rem; cursor: pointer; }

        .const-reference {
            position: fixed; bottom: 30px; right: 30px; width: 200px; height: 200px;
            background: rgba(10, 20, 40, 0.9); border: 2px solid var(--accent); border-radius: 12px;
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 40;
        }
        .const-reference svg { width: 140px; height: 140px; }

        .part-drop {
            position: fixed; top: -50px; font-size: 3rem; z-index: 100;
            animation: dropAnim 1.2s forwards cubic-bezier(0.5, 0, 0.7, 0.5);
        }
        @keyframes dropAnim { to { transform: translateY(110vh) rotate(720deg); } }

        /* --- ç”»é¢å››ï¼šæ ‡æœ¬å¢™ --- */
        #page-wall { background: radial-gradient(circle, #1a2a3a, #05070a); overflow-y: auto; text-align: center; }
        .wall-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; width: 80%; max-width: 900px; margin: 40px auto; }
        .specimen-card {
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,204,0,0.2); border-radius: 20px;
            padding: 20px; cursor: pointer; transition: 0.3s;
        }
        .specimen-card:hover { transform: scale(1.05); border-color: var(--accent); }
        .const-model { font-size: 4rem; margin-bottom: 10px; }

        /* --- ç”»é¢äº”ï¼šå¯¼å¸ˆå¯„è¯­ --- */
        .mentor-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 4000;
        }
        .mentor-img { width: 180px; height: 180px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 30px; }

        .btn { padding: 12px 35px; background: var(--primary); border: none; color: white; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        
        /* å¯¼èˆªæç¤ºç®­å¤´ */
        #nav-arrow {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            color: var(--accent); font-weight: bold; display: none; z-index: 30;
            text-shadow: 0 0 10px black;
        }
    </style>
</head>
<body>

    <section id="page-intro" class="page active">
        <div class="intro-card">
            <h1 style="color: var(--accent); margin-bottom: 10px;">æ˜Ÿæ˜Ÿçš„é‚€çº¦</h1>
            <p style="margin-bottom: 30px; opacity: 0.8;">ä½¿ç”¨æœ›è¿œé•œå¯»æ‰¾å¹¶ç‚¹äº®æ˜Ÿç©ºä¸­çš„ç§˜å¯†</p>
            <button class="btn" onclick="startSequence()">å¼€å§‹æ¢ç´¢</button>
        </div>
    </section>

    <section id="page-explore" class="page">
        <div class="sky-world" id="sky-world">
            <div class="ground-overlay" id="ground"></div>
            <canvas id="line-canvas" style="position:absolute; top:0; left:0; pointer-events:none; z-index:15;"></canvas>
            <div id="stars-container"></div>
        </div>

        <div class="telescope-lens"></div>
        
        <div id="nav-arrow">â† ç§»åŠ¨è§†é‡å¯»æ‰¾æ›´å¤šæ˜Ÿåº§ â†’</div>

        <div class="move-hints">
            <div class="key-hint" onclick="viewX += 400; updateSkyPosition()">â—€ å‘å·¦å¹³ç§»</div>
            <div class="key-hint" onclick="viewX -= 400; updateSkyPosition()">å‘å³å¹³ç§» â–¶</div>
        </div>

        <div class="const-reference" id="const-ref">
            <p style="font-size: 0.75rem; color: var(--accent); font-weight: bold; margin-bottom: 5px;" id="ref-title">å‚è€ƒå›¾</p>
            <svg id="ref-svg" viewBox="0 0 100 100"></svg>
        </div>
    </section>

    <section id="page-wall" class="page">
        <h2 style="color: var(--accent); margin-top: 50px;">â­ æˆ‘çš„æ˜Ÿåº§æ ‡æœ¬å¢™ â­</h2>
        <div class="wall-grid" id="wall-grid"></div>
        <div style="margin-top: 40px;">
            <button class="btn" onclick="showFinalMentor()" style="margin-right: 20px;">é¢è§å¯¼å¸ˆ</button>
            <!-- <button class="btn" onclick="goToNextLevel()">ç»§ç»­æ¢ç´¢-å¯èˆªç ”ç©¶</button> -->
        </div>
    </section>

    <div class="mentor-overlay" id="mentor-overlay">
        <div style="text-align: center; max-width: 700px; padding: 20px;">
            <img src="https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&q=80&w=200" class="mentor-img">
            <h3 style="color: var(--accent); margin-bottom: 20px;">ç‹äºšå¹³å¯¼å¸ˆçš„å¯„è¯­</h3>
            <p id="speech-text" style="line-height: 1.8; font-size: 1.15rem; color: #eee;"></p>
            <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
                <button class="btn" onclick="location.reload()">é‡æ–°æ¢ç´¢</button>
                <button class="btn" onclick="goToNextLevel()">ç»§ç»­æ¢ç´¢-å¯èˆªç ”ç©¶</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let viewX = -800, viewY = -400;
        let activeIdx = -1;
        let currentPath = [];
        let completedConsts = [];

        // é‡æ–°è°ƒæ•´äº†åæ ‡ï¼Œç¡®ä¿ä¸‰ä¸ªæ˜Ÿåº§åˆ†å¸ƒåœ¨å·¦å³ä¸åŒçš„åŒºåŸŸ
        const CONSTELLATIONS = [
            { 
                name: "å¤§ç†Šåº§", 
                stars: [{x: 1000, y: 1200}, {x: 1100, y: 1250}, {x: 1200, y: 1220}, {x: 1250, y: 1300}, {x: 1150, y: 1380}],
                icon: "ğŸ»", part: "ğŸš€",
                connections: [[0,1], [1,2], [2,3], [3,4]] // æ­£ç¡®çš„è¿çº¿é¡ºåº
            },
            { 
                name: "å¤©é¹…åº§", 
                stars: [{x: 2000, y: 1100}, {x: 2050, y: 1200}, {x: 2100, y: 1300}, {x: 1950, y: 1230}, {x: 2150, y: 1180}],
                icon: "ğŸ¦¢", part: "âš™ï¸",
                connections: [[0,1], [1,2], [0,3], [0,4]] // æ­£ç¡®çš„è¿çº¿é¡ºåº
            },
            { 
                name: "ä»™é¹¤åº§", 
                stars: [{x: 3000, y: 1300}, {x: 3100, y: 1350}, {x: 3200, y: 1320}, {x: 3150, y: 1400}],
                icon: "ğŸ¦©", part: "ğŸ”‹",
                connections: [[0,1], [1,2], [2,3]] // æ­£ç¡®çš„è¿çº¿é¡ºåº
            }
        ];

        function startSequence() {
            document.getElementById('page-intro').classList.remove('active');
            document.getElementById('page-explore').classList.add('active');
            
            const ground = document.getElementById('ground');
            setTimeout(() => {
                ground.style.transition = "transform 3s, opacity 2s";
                ground.style.transform = "translateY(100vh)";
                ground.style.opacity = "0";
                
                viewY = -1000; // å‘ä¸Šè¿é•œåˆ°æ˜Ÿç©ºé«˜åº¦
                updateSkyPosition();
                
                setTimeout(() => {
                    ground.style.display = 'none';
                    initGameSpace();
                }, 3000);
            }, 500);
        }

        function initGameSpace() {
            const container = document.getElementById('stars-container');
            CONSTELLATIONS.forEach((c, cIdx) => {
                c.stars.forEach((s, sIdx) => {
                    const dot = document.createElement('div');
                    dot.className = 'star-dot';
                    dot.style.left = s.x + 'px';
                    dot.style.top = s.y + 'px';
                    dot.onclick = () => handleStarClick(cIdx, sIdx, dot);
                    container.appendChild(dot);
                });
            });
            // åˆå§‹åŒ–ç”»å¸ƒ
            drawAllLines();
            requestAnimationFrame(gameLoop);
        }

        function handleStarClick(cIdx, sIdx, el) {
            // åªæœ‰å½“æœ›è¿œé•œå¯¹å‡†å½“å‰æ˜Ÿåº§ï¼Œä¸”æ˜Ÿåº§æœªå®Œæˆæ—¶ï¼Œæ‰å…è®¸ç‚¹å‡»
            if (completedConsts.includes(cIdx)) return;
            if (activeIdx === -1) return; // è¿˜æ²¡æœ‰å¯¹å‡†ä»»ä½•æ˜Ÿåº§
            if (activeIdx !== cIdx) return; // å¯¹å‡†çš„ä¸æ˜¯è¿™ä¸ªæ˜Ÿåº§

            currentPath.push(sIdx);
            el.classList.add('active');
            
            // é‡æ–°ç»˜åˆ¶æ‰€æœ‰è¿çº¿
            drawAllLines();

            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰æ˜Ÿæ˜Ÿ
            if (currentPath.length === CONSTELLATIONS[cIdx].stars.length) {
                // éªŒè¯è¿çº¿æ˜¯å¦æ­£ç¡®
                if (validateConstellationConnection(cIdx)) {
                    completedConsts.push(cIdx);
                    spawnPart(CONSTELLATIONS[cIdx].part);
                    currentPath = [];
                    drawAllLines(); // é‡ç»˜æ‰€æœ‰è¿çº¿ï¼ˆåŒ…æ‹¬å®Œæˆçš„ï¼‰
                    if (completedConsts.length === 3) handleWin();
                } else {
                    // è¿çº¿é”™è¯¯ï¼Œé‡ç½®å½“å‰æ˜Ÿåº§
                    currentPath = [];
                    document.querySelectorAll('.star-dot.active').forEach(dot => {
                        dot.classList.remove('active');
                    });
                    drawAllLines(); // é‡ç»˜å®Œæˆçš„æ˜Ÿåº§è¿çº¿
                }
            }
        }

        function validateConstellationConnection(cIdx) {
            // ç®€åŒ–éªŒè¯ï¼šåªè¦ç‚¹äº®äº†æ‰€æœ‰æ˜Ÿæ˜Ÿå°±ç®—å®Œæˆ
            return currentPath.length === CONSTELLATIONS[cIdx].stars.length;
        }

        // ç»˜åˆ¶æ‰€æœ‰è¿çº¿ï¼ˆåŒ…æ‹¬å·²å®Œæˆå’Œå½“å‰ï¼‰
        function drawAllLines() {
            const canvas = document.getElementById('line-canvas');
            canvas.width = 5000; canvas.height = 3000;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,5000,3000);
            
            // ç»˜åˆ¶å·²å®Œæˆæ˜Ÿåº§çš„çº¿ï¼ˆå®çº¿ï¼‰
            ctx.strokeStyle = "rgba(255, 204, 0, 0.7)";
            ctx.lineWidth = 4;
            ctx.setLineDash([]);

            completedConsts.forEach(idx => {
                const c = CONSTELLATIONS[idx];
                // æŒ‰ç…§é¢„è®¾çš„æ­£ç¡®è·¯å¾„ç»˜åˆ¶
                c.connections.forEach(conn => {
                    ctx.beginPath();
                    ctx.moveTo(c.stars[conn[0]].x, c.stars[conn[0]].y);
                    ctx.lineTo(c.stars[conn[1]].x, c.stars[conn[1]].y);
                    ctx.stroke();
                });
            });

            // ç»˜åˆ¶å½“å‰æ­£åœ¨è¿æ¥çš„çº¿ï¼ˆè™šçº¿ï¼‰
            if (activeIdx !== -1 && currentPath.length > 1) {
                ctx.strokeStyle = "rgba(255, 204, 0, 0.7)";
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 5]);
                
                // ç»˜åˆ¶å½“å‰è·¯å¾„çš„æ‰€æœ‰è¿çº¿
                for (let i = 1; i < currentPath.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(CONSTELLATIONS[activeIdx].stars[currentPath[i-1]].x, CONSTELLATIONS[activeIdx].stars[currentPath[i-1]].y);
                    ctx.lineTo(CONSTELLATIONS[activeIdx].stars[currentPath[i]].x, CONSTELLATIONS[activeIdx].stars[currentPath[i]].y);
                    ctx.stroke();
                }
            }
        }

        function gameLoop() {
            if (!document.getElementById('page-explore').classList.contains('active')) return;

            // è·å–æœ›è¿œé•œä¸­å¿ƒåæ ‡
            const worldX = (window.innerWidth / 2) - viewX;
            const worldY = (window.innerHeight / 2) - viewY;

            let foundIdx = -1;
            CONSTELLATIONS.forEach((c, idx) => {
                if (completedConsts.includes(idx)) return;
                // æ£€æµ‹èŒƒå›´å†…æ˜¯å¦æœ‰æ˜Ÿåº§çš„ä»»æ„ä¸€é¢—æ˜Ÿ
                let inRange = false;
                c.stars.forEach(star => {
                    const dx = worldX - star.x;
                    const dy = worldY - star.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 400) inRange = true;
                });
                if (inRange) foundIdx = idx;
            });

            activeIdx = foundIdx;
            const ref = document.getElementById('const-ref');
            const nav = document.getElementById('nav-arrow');

            if (activeIdx !== -1) {
                ref.style.display = 'flex';
                nav.style.display = 'none';
                document.getElementById('ref-title').innerText = CONSTELLATIONS[activeIdx].name;
                renderRefSvg(CONSTELLATIONS[activeIdx]);
            } else {
                ref.style.display = 'none';
                nav.style.display = 'block';
            }

            requestAnimationFrame(gameLoop);
        }

        function renderRefSvg(data) {
            const svg = document.getElementById('ref-svg');
            const first = data.stars[0];
            const scale = 0.06; // æ”¾å¤§ç¼©æ”¾æ¯”ä¾‹
            svg.innerHTML = '';
            
            // ç»˜åˆ¶æ˜Ÿç‚¹
            data.stars.forEach(s => {
                const x = (s.x - first.x) * scale + 70;
                const y = (s.y - first.y) * scale + 70;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '4');
                circle.setAttribute('fill', 'white');
                svg.appendChild(circle);
            });
            
            // æŒ‰ç…§æ­£ç¡®çš„è¿æ¥é¡ºåºç»˜åˆ¶è¿çº¿
            data.connections.forEach(conn => {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', (data.stars[conn[0]].x - first.x) * scale + 70);
                line.setAttribute('y1', (data.stars[conn[0]].y - first.y) * scale + 70);
                line.setAttribute('x2', (data.stars[conn[1]].x - first.x) * scale + 70);
                line.setAttribute('y2', (data.stars[conn[1]].y - first.y) * scale + 70);
                line.setAttribute('stroke', 'var(--accent)');
                line.setAttribute('stroke-width', '3');
                svg.appendChild(line);
            });
        }

        function spawnPart(emoji) {
            const part = document.createElement('div');
            part.className = 'part-drop';
            part.innerText = emoji;
            part.style.left = '50%';
            document.body.appendChild(part);
            setTimeout(() => part.remove(), 1300);
        }

        function updateSkyPosition() {
            // é™åˆ¶è§†é‡è¾¹ç•Œ
            if (viewX > 0) viewX = 0;
            if (viewX < -3500) viewX = -3500;
            document.getElementById('sky-world').style.transform = `translate(${viewX}px, ${viewY}px)`;
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') viewX += 100;
            if (e.key === 'ArrowRight' || e.key === 'd') viewX -= 100;
            updateSkyPosition();
        });

        window.addEventListener('mousemove', (e) => {
            document.documentElement.style.setProperty('--mx', e.clientX + 'px');
            document.documentElement.style.setProperty('--my', e.clientY + 'px');
        });

        function handleWin() {
            setTimeout(() => {
                document.getElementById('page-explore').classList.remove('active');
                document.getElementById('page-wall').classList.add('active');
                const grid = document.getElementById('wall-grid');
                grid.innerHTML = CONSTELLATIONS.map(c => `
                    <div class="specimen-card">
                        <div class="const-model">${c.icon}</div>
                        <h3 style="color:var(--accent)">${c.name}</h3>
                    </div>
                `).join('');
            }, 1500);
        }

        function showFinalMentor() {
            document.getElementById('mentor-overlay').style.display = 'flex';
            document.getElementById('speech-text').innerText = "ä½ çœ‹ï¼Œå½“æ‰€æœ‰çš„æ˜Ÿç‚¹è¿æˆä¸€çº¿ï¼Œå¯‚é™çš„æ˜Ÿç©ºå°±æœ‰äº†åå­—ã€‚ä½ åˆšåˆšäº²æ‰‹ç‚¹äº®çš„ä¸ä»…æ˜¯æ˜Ÿåº§ï¼Œæ›´æ˜¯é€šå¾€ç§‘å­¦æ®¿å ‚çš„é˜¶æ¢¯ã€‚æ¯ä¸€ä¸ªå¥³å­©éƒ½æ˜¯ä¸€é¢—ç‹¬ç‰¹çš„æ˜Ÿï¼Œå½“ä½ æ•¢äºåœ¨é»‘æš—ä¸­å‘å…‰ï¼Œæ•´ä¸ªå®‡å®™éƒ½ä¼šä¸ºä½ é—ªçƒã€‚ä¿æŒè¿™ä»½æ¢ç´¢çš„æ¸´æœ›ï¼Œå»ä¹¦å†™å±äºä½ çš„æ˜Ÿé™…èˆªè¡Œå¿—å§ï¼";
        }

        // è·³è½¬åˆ°ä¸‹ä¸€å…³
        function goToNextLevel() {
            // ç›´æ¥è·³è½¬åˆ°ç¬¬äºŒå…³
            window.location.href = '../index.html#level2';
        }
    </script>
</body>
</html>